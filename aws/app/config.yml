stackName: orma

stage: prod

buckets:
  internal: orma-d-deploy

lambdaProcessingRoleArn: {{iamroles.lambdaProcessingRoleArn}}

rds:
  name: openroads
  username: {{RDS_USER}}
  password: {{RDS_PASS}}

ecs:
  amiid: ami-9d1f7efe
  instanceType: t2.medium
  ecsInstanceProfileArn: arn:aws:iam::552819999234:instance-profile/orma-ecs
  volumeSize: 50
  vpcId: vpc-1dda3b78
  keyPairName: orma
  availabilityZone: '!Sub ${AWS::Region}a'
  maxInstances: 1
  desiredInstances: 1
  services:
    - count: 1
      name: vn
      containers:
        - name: webapp
          image: developmentseed/openroads-vn-api:latest
          cpu: 100
          memory: 800
          ports:
            - container: 4000
              host: 80
              protocol: tcp
          envs:
            AWS_DEFAULT_REGION: '!Sub ${AWS::Region}'
            AWS_REGION: '!Sub ${AWS::Region}'
        - name: tiler
          image: developmentseed/openroads-tiler:latest
          cpu: 50
          memory: 500
          commands:
            - cd /opt/app
            - echo 'export DATABASE_URL=$DATABASE_URL' >> .env
            - echo 'export S3_BUCKET=$S3_BUCKET' >> .env
            - echo 'export PATH=$PATH:/usr/local/bin' >> .env
            - echo '*/5 * * * * . /opt/app/.env; cd /opt/app; node index.js >> /opt/app/cron.log 2>&1' | crontab
            - cron start -f
          envs:
            S3_BUCKET: openroads-vn-tiles
            S3_TEMPLATE: s3://openroads-vn-tiles/tiles/{z}/{x}/{y}.vector.pbf
        - name: vn-tiler
          image: developmentseed/openroads-vn-tiler:latest
          cpu: 50
          memory: 500
          commands:
            - cd /opt/app
            - echo 'export DATABASE_URL=$DATABASE_URL' >> .env
            - echo 'export S3_BUCKET=$S3_BUCKET' >> .env
            - echo 'export PATH=$PATH:/usr/local/bin' >> .env
            - echo '*/5 * * * * . /opt/app/.env; cd /opt/app; node index.js >> /opt/app/cron.log 2>&1' | crontab
            - cron start -f
          envs:
            S3_BUCKET: openroads-vn-tiles
            S3_TEMPLATE: s3://openroads-vn-tiles/tiles/{z}/{x}/{y}.vector.pbf

# used as custom resource for cloudformation manipulation
#lambdas:
#- name: CustomBootstrap
#  handler: init-schema.handler
#  timeout: 100
#  memory: 256
#  source: 'db/lambda/init-schema.js'
